<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements. See the NOTICE file
distributed with this work for additional information
regarding copyright ownership. The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License. You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied. See the License for the
specific language governing permissions and limitations
under the License.
-->

<div class="kyc-container">
  <!-- Modern Header Section -->
  <div class="kyc-header">
    <div class="header-content">
      <mat-icon class="header-icon">security</mat-icon>
      <div class="header-text">
        <h1 class="page-title">KYC Management</h1>
        <p class="page-subtitle">
          Client: <strong>{{ clientData?.displayName }}</strong> ({{ clientData?.accountNo }})
        </p>
      </div>
    </div>
  </div>

  <!-- Progress Bar -->
  <mat-progress-bar
    mode="indeterminate"
    *ngIf="isLoading || isVerificationInProgress"
    class="progress-bar"
  ></mat-progress-bar>

  <!-- KYC Verified Badge (when verified) -->
  <div *ngIf="hasExistingKyc && isKycVerified()" class="kyc-verified-badge">
    <mat-icon>check_circle</mat-icon>
    <div class="badge-content">
      <h3>KYC Verified</h3>
      <p>PAN and Aadhaar verified successfully</p>
    </div>
  </div>

  <!-- Main Content Layout -->
  <div class="main-content">
    <!-- Left Column - Document Details -->
    <div class="document-details-section">
      <!-- Document Details Card -->
      <div *ngIf="hasExistingKyc && !isEditMode" class="details-card">
        <div class="card-header">
          <mat-icon>description</mat-icon>
          <h2>Document Details</h2>
        </div>
        <p class="card-subtitle">Detailed view of KYC document information</p>

        <div class="document-overview">
          <h3>Document Overview</h3>

          <!-- Document Fields Grid -->
          <div class="document-grid">
            <div class="document-item">
              <div class="document-label">PAN Number</div>
              <div class="document-value-section">
                <span class="document-value" [class.empty-value]="!kycData.panNumber">
                  {{ kycData.panNumber || '–' }}
                </span>
                <mat-icon
                  class="status-icon"
                  [class.verified]="kycData.panVerified"
                  [class.unverified]="!kycData.panVerified"
                >
                  {{ kycData.panVerified ? 'check_circle' : 'cancel' }}
                </mat-icon>
              </div>
            </div>

            <div class="document-item">
              <div class="document-label">Aadhaar Number</div>
              <div class="document-value-section">
                <span class="document-value" [class.empty-value]="!kycData.aadhaarNumber">
                  {{ kycData.aadhaarNumber || '–' }}
                </span>
                <mat-icon
                  class="status-icon"
                  [class.verified]="kycData.aadhaarVerified"
                  [class.unverified]="!kycData.aadhaarVerified"
                >
                  {{ kycData.aadhaarVerified ? 'check_circle' : 'cancel' }}
                </mat-icon>
              </div>
            </div>

            <div class="document-item">
              <div class="document-label">Driving License</div>
              <div class="document-value-section">
                <span class="document-value" [class.empty-value]="!kycData.drivingLicenseNumber">
                  {{ kycData.drivingLicenseNumber || '–' }}
                </span>
                <mat-icon
                  class="status-icon"
                  [class.verified]="kycData.drivingLicenseVerified"
                  [class.unverified]="!kycData.drivingLicenseVerified"
                >
                  {{ kycData.drivingLicenseVerified ? 'check_circle' : 'cancel' }}
                </mat-icon>
              </div>
            </div>

            <div class="document-item">
              <div class="document-label">Voter ID</div>
              <div class="document-value-section">
                <span class="document-value" [class.empty-value]="!kycData.voterIdNumber">
                  {{ kycData.voterIdNumber || '–' }}
                </span>
                <mat-icon
                  class="status-icon"
                  [class.verified]="kycData.voterIdVerified"
                  [class.unverified]="!kycData.voterIdVerified"
                >
                  {{ kycData.voterIdVerified ? 'check_circle' : 'cancel' }}
                </mat-icon>
              </div>
            </div>

            <div class="document-item">
              <div class="document-label">Passport Number</div>
              <div class="document-value-section">
                <span class="document-value" [class.empty-value]="!kycData.passportNumber">
                  {{ kycData.passportNumber || '–' }}
                </span>
                <mat-icon
                  class="status-icon"
                  [class.verified]="kycData.passportVerified"
                  [class.unverified]="!kycData.passportVerified"
                >
                  {{ kycData.passportVerified ? 'check_circle' : 'cancel' }}
                </mat-icon>
              </div>
            </div>
          </div>

          <!-- Verification Notes -->
          <div *ngIf="kycData.manualVerificationNotes || kycData.verificationNotes" class="verification-notes">
            <h4><mat-icon>note</mat-icon> Additional Data</h4>
            <div class="notes-content">
              <div class="notes-label">Notes</div>
              <div class="notes-text">{{ kycData.manualVerificationNotes || kycData.verificationNotes }}</div>
            </div>
          </div>
        </div>

        <!-- Edit Button -->
        <div class="card-actions">
          <button
            mat-raised-button
            color="primary"
            (click)="toggleEditMode()"
            [disabled]="isLoading || isVerificationInProgress"
          >
            <mat-icon>edit</mat-icon>
            Edit Details
          </button>
        </div>
      </div>

      <!-- Edit Mode Form -->
      <div *ngIf="isEditMode" class="edit-form-card">
        <div class="card-header">
          <mat-icon>{{ hasExistingKyc ? 'edit' : 'add_circle' }}</mat-icon>
          <h2>{{ hasExistingKyc ? 'Edit KYC Document Details' : 'Add KYC Document Details' }}</h2>
        </div>
        <p class="card-subtitle">{{ hasExistingKyc ? 'Update' : 'Add' }} client identification documents</p>

        <form [formGroup]="kycDetailsForm" class="kyc-form">
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>PAN Number</mat-label>
              <input matInput formControlName="panNumber" placeholder="ABCDE1234F" maxlength="10" />
              <mat-icon matSuffix>credit_card</mat-icon>
              <mat-hint>10-character PAN format</mat-hint>
              <mat-error *ngIf="hasFieldError('panNumber')">{{ getFieldErrorMessage('panNumber') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Aadhaar Number</mat-label>
              <input matInput formControlName="aadhaarNumber" placeholder="123456789012" maxlength="12" />
              <mat-icon matSuffix>fingerprint</mat-icon>
              <mat-hint>12-digit Aadhaar number</mat-hint>
              <mat-error *ngIf="hasFieldError('aadhaarNumber')">{{ getFieldErrorMessage('aadhaarNumber') }}</mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Driving License Number</mat-label>
              <input
                matInput
                formControlName="drivingLicenseNumber"
                placeholder="Enter driving license number"
                maxlength="20"
              />
              <mat-icon matSuffix>drive_eta</mat-icon>
              <mat-error *ngIf="hasFieldError('drivingLicenseNumber')">{{
                getFieldErrorMessage('drivingLicenseNumber')
              }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Voter ID</mat-label>
              <input matInput formControlName="voterId" placeholder="Enter voter ID number" maxlength="20" />
              <mat-icon matSuffix>how_to_vote</mat-icon>
              <mat-error *ngIf="hasFieldError('voterId')">{{ getFieldErrorMessage('voterId') }}</mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="form-field-full">
            <mat-label>Passport Number</mat-label>
            <input matInput formControlName="passportNumber" placeholder="Enter passport number" maxlength="20" />
            <mat-icon matSuffix>flight_takeoff</mat-icon>
            <mat-error *ngIf="hasFieldError('passportNumber')">{{ getFieldErrorMessage('passportNumber') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-full">
            <mat-label>Verification Notes</mat-label>
            <textarea
              matInput
              formControlName="verificationNotes"
              rows="4"
              placeholder="Enter verification notes, observations, or special instructions..."
            ></textarea>
            <mat-icon matSuffix>note_add</mat-icon>
            <mat-hint>Optional notes for verification process</mat-hint>
          </mat-form-field>
        </form>

        <div class="form-actions">
          <button mat-button (click)="toggleEditMode()" [disabled]="isLoading">
            <mat-icon>cancel</mat-icon>
            Cancel
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="saveKycDetails()"
            [disabled]="isLoading || kycDetailsForm.invalid"
          >
            <mat-icon>save</mat-icon>
            {{ hasExistingKyc ? 'Update' : 'Save' }} KYC Details
          </button>
        </div>
      </div>

      <!-- No KYC Data State -->
      <div *ngIf="!hasExistingKyc && !isEditMode" class="no-data-card">
        <div class="no-data-content">
          <mat-icon class="no-data-icon">assignment_late</mat-icon>
          <h3>No KYC Details Found</h3>
          <p>
            No KYC details have been added for this client yet. Get started by adding the client's identification
            documents.
          </p>
          <button mat-raised-button color="primary" (click)="toggleEditMode()" [disabled]="isLoading">
            <mat-icon>add_circle</mat-icon>
            Add KYC Details
          </button>
          <p class="disclaimer">
            <mat-icon>info</mat-icon>
            KYC functionality is ready but may require backend database setup completion.
          </p>
        </div>
      </div>
    </div>

    <!-- Right Column - Status & Actions -->
    <div class="status-actions-section">
      <!-- Verification Status Card -->
      <div class="status-card">
        <div class="card-header">
          <mat-icon>verified_user</mat-icon>
          <h2>Verification Status</h2>
        </div>

        <div *ngIf="hasExistingKyc; else noKycStatus" class="status-content">
          <div class="status-item">
            <span class="status-label">Overall Status:</span>
            <span class="status-badge" [class.verified]="isKycVerified()" [class.pending]="!isKycVerified()">
              {{ isKycVerified() ? 'Verified' : 'Pending' }}
            </span>
          </div>

          <div class="status-item">
            <span class="status-label">Documents Verified:</span>
            <span class="status-count">{{ getVerifiedDocumentCount() }} / {{ getProvidedDocumentCount() }}</span>
          </div>

          <div class="progress-bar-container">
            <mat-progress-bar
              mode="determinate"
              [value]="(getVerifiedDocumentCount() / getProvidedDocumentCount()) * 100"
              color="primary"
            ></mat-progress-bar>
          </div>
        </div>

        <ng-template #noKycStatus>
          <div class="no-status-content">
            <mat-icon>info_outline</mat-icon>
            <p>Add KYC details to enable verification.</p>
          </div>
        </ng-template>
      </div>

      <!-- Actions Card -->
      <div *ngIf="hasExistingKyc" class="actions-card">
        <div class="card-header">
          <mat-icon>build</mat-icon>
          <h2>Actions</h2>
        </div>

        <div class="actions-content">
          <button
            mat-stroked-button
            color="accent"
            (click)="verifyKycManually()"
            [disabled]="isLoading || isVerificationInProgress"
            class="action-button"
          >
            <mat-icon>verified</mat-icon>
            Manual Verification
          </button>

          <button
            mat-stroked-button
            color="warn"
            (click)="unverifyKycManually()"
            [disabled]="isLoading || isVerificationInProgress"
            class="action-button"
          >
            <mat-icon>gpp_maybe</mat-icon>
            Unverify Documents
          </button>

          <button
            mat-stroked-button
            color="primary"
            (click)="verifyKycViaApi()"
            [disabled]="
              isLoading ||
              isVerificationInProgress ||
              !isApiVerificationEnabled ||
              (!kycData.panNumber && !kycData.aadhaarNumber)
            "
            [matTooltip]="getApiVerificationTooltip()"
            class="action-button"
          >
            <mat-icon>cloud_sync</mat-icon>
            API Verification
          </button>
        </div>
      </div>

      <!-- Verified By Section (Horizontal) -->
      <div *ngIf="hasExistingKyc && kycData.lastVerifiedOn" class="verified-by-card">
        <div class="verified-by-content">
          <div class="verified-info">
            <span class="verified-label">LAST VERIFIED</span>
            <span class="verified-date">{{ kycData.lastVerifiedOn | date: 'dd MMM yyyy' }}</span>
          </div>
          <div class="verified-info">
            <span class="verified-label">VERIFIED BY</span>
            <span class="verified-by">{{ kycData.lastVerifiedByUsername || 'System' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
