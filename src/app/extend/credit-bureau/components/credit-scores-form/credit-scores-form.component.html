<!-- Credit Scores Section -->
<mat-card class="section-card">
  <mat-card-header>
    <mat-card-title>Credit Scores</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <div [formGroup]="parentForm">
      <div formArrayName="creditScores">
        <div *ngFor="let scoreGroup of creditScores.controls; let i = index" [formGroupName]="i" class="score-group">
          <div class="score-header">
            <h4>Score {{ i + 1 }}</h4>
            <button
              type="button"
              mat-icon-button
              color="warn"
              (click)="removeCreditScore(i)"
              [disabled]="isDeleteDisabled()"
              [attr.aria-label]="'Remove score ' + (i + 1)"
              matTooltip="Remove Score"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <!-- Basic Score Information -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Score Model</mat-label>
              <mat-select formControlName="scoreModel" required>
                <mat-option *ngFor="let model of scoreModels" [value]="model.code">
                  {{ model.description }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="scoreGroup.get('scoreModel')?.hasError('required')">
                {{ getErrorMessage('scoreModel', i) }}
              </mat-error>
              <mat-error *ngIf="isScoreModelDuplicated(i)">
                This score model is already used. Each score model can only be used once per report.
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Credit Score</mat-label>
              <input matInput type="number" formControlName="creditScore" placeholder="300-900" required />
              <mat-hint>Valid range: 300-900</mat-hint>
              <mat-error *ngIf="scoreGroup.get('creditScore')?.hasError('required')">
                {{ getErrorMessage('creditScore', i) }}
              </mat-error>
              <mat-error
                *ngIf="
                  scoreGroup.get('creditScore')?.hasError('min') ||
                  scoreGroup.get('creditScore')?.hasError('max') ||
                  scoreGroup.get('creditScore')?.hasError('pattern')
                "
              >
                {{ getErrorMessage('creditScore', i) }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Enhanced Score Metadata -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Score Version</mat-label>
              <input matInput formControlName="scoreVersion" placeholder="e.g., 2.0" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Score Name</mat-label>
              <input matInput formControlName="scoreName" placeholder="e.g., CIBIL Score" />
            </mat-form-field>
          </div>

          <!-- Score Percentile -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Score Percentile</mat-label>
              <input matInput type="number" formControlName="scorePercentile" placeholder="0-100" step="0.01" />
              <mat-error
                *ngIf="
                  scoreGroup.get('scorePercentile')?.hasError('min') ||
                  scoreGroup.get('scorePercentile')?.hasError('max')
                "
              >
                {{ getErrorMessage('scorePercentile', i) }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Score Reason -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Score Reason/Notes</mat-label>
            <textarea
              matInput
              formControlName="scoreReason"
              rows="2"
              placeholder="Explanation for this score"
            ></textarea>
          </mat-form-field>
        </div>
      </div>
    </div>

    <div class="add-score-section">
      <button type="button" mat-stroked-button color="primary" (click)="addCreditScore()">
        <mat-icon>add</mat-icon>
        Add Another Score
      </button>
    </div>
  </mat-card-content>
</mat-card>
